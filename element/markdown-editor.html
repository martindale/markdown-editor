<link rel="import" href="../bower_components/polymer/polymer.html" />
<link rel="import" href="../bower_components/core-overlay/core-overlay.html" />

<polymer-element name="markdown-editor" attributes="value lineNumbers" noscript>
	<template>
		<link rel="stylesheet" href="../bower_components/codemirror/lib/codemirror.css">
		<link rel="stylesheet" type="text/css" href="markdown-editor.css"/>
		<div id="container" layout horizontal>
			<div class="block">
				<span id="help" on-click="{{ help }}">?</span>
				<h2 class="info">Markdown</h2>
				<div id="editor"></div>
			</div>
			<div class="block">
				<h2 class="info">Preview</h2>
				<div id="preview"></div>
			</div>
		</div>
		<core-overlay backdrop="true" id="help-dialog">
			<div id="help-dialog-content">
				<span class="close" core-overlay-toggle>X</span>
				<h2>Help</h2>
  				<div><span class="markdown"># heading</span> : H1 heading</div>
  				<div><span class="markdown">## heading</span> : H2 heading</div>
  				<div><span class="markdown">* item</span> : unordered list</div>
  				<div><span class="markdown">1. item</span> : orderd list</div>
  			</div>
		</core-overlay>
	</template>

	<script src="../bower_components/marked/lib/marked.js"></script>
	<script src="../bower_components/codemirror/lib/codemirror.js"></script>
	<script src="../bower_components/codemirror/mode/markdown/markdown.js"></script>
  <script>
    Polymer('markdown-editor', {
    	observe: {
    		'model.value': 'modelValueChanged'
    	},
      ready: function() {
      			var previewElement  = this.shadowRoot.getElementById('preview');
      			var markdownElement = this.shadowRoot.getElementById('editor');

      			var editor = CodeMirror(markdownElement, {
    				  mode: "markdown",
    				  lineNumbers: true
  				  });

      			var _this = this;

  				editor.on('changes', function () {
  					_this.model.setValue(editor.getValue());
  				});

  				this.modelValueChanged = function(oldValue, newValue) {
  					if (editor.getValue() != newValue) {
  						editor.setValue(newValue);
  					}

  					_this.value = newValue;
  					_this.reloadPreview();
  				};

  				this.reloadPreview = function() {
  					previewElement.innerHTML  = marked(editor.getValue());
  				};

  				this.help = function() {
  					_this.shadowRoot.getElementById('help-dialog').opened = true;
  				};

  				// INIT
  				this.model = new MarkdownEditorModel(this.innerHTML);
      		},
      		valueChanged: function(oldValue, newValue) {
      			this.model.setValue(newValue);
      		}
    	});

		var MarkdownEditorModel = function(value) {
			this.value = value;
		};

		MarkdownEditorModel.prototype.setValue = function(value) {
			if (value != this.value) {
			 this.value = value;	
			}
		};
  	</script>
</polymer-element>